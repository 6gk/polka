#!/bin/sh
#  simple script to download from multiple places

fun() {
	[ "$1" = m ] && return
	out=${2:-${1##*/}}

	# dirs
	[ -d "$out" ] && out=$2/${1##*/}

	# change filename if already existing
	[ -e "$out" ] && out=$out-0 &&
		while [ -e "$out" ]; do
			out=${out%-*}-$(( ${out##*-} + 1 ))
		done

	# print url
	printf '\n%b\n' "\033[35m${1#http*://}\033[0m"

	# shorthand git | ex: user/repo
	v=$(echo "$1" | tr -cd /.)
	[ "$v" = / ] && { git clone "https://github.com/$1" $2; return; }

	# search for most popular repo | ex: repo
	[ "$v" = '' ] && {
		# get first search result
		repo=$(curl -s https://api.github.com/search/repositories?q="$1" \
			| grep -i "full_name.*/$1\"" | head -n1 | sed -n 's/.*: "\(.*\)".*/\1/p')

		[ "$repo" ] && git clone "https://github.com/$repo" $2
		return
	}

	# add missing https
	case $1 in
		http*) ;;
		*) set -- "https://$1" "$2"
	esac


	case $1 in
		# individual file github urls
		*github*/raw/*|*github*/blob/*)
			curl -L#o "$out"  "$(echo "$1" | sed 's|/blob/|/raw/|')";;

		# git repos
		*.git|*git.*|*github.com*|*gitlab*) git clone "$1" $2;;

		# youtube
		*youtu.be*|*youtube.com*) youtube-dl "$1" \
			--geo-bypass --embed-subs --add-metadata \
			--ignore-errors -o "${2:-%(title)s.mp4}" \
			-f 'bestvideo[height<=1080]+bestaudio/best[height<=1080]';;

		# unsplash
		*unsplash.com*) v=${1%/download*}
			curl -L#o "${2:-${v##*/}.jpeg}" "$v/download?force=true";;

		# other
		*) curl -L#o "$out"  "$1";;
	esac
}

# multiple urls
if [ $# -le 2 ]; then
	fun "${1%/}" "$2"
else
	for i; do fun "$i"; done
fi

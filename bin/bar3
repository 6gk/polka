#!/usr/bin/env bash

#set -x

fg="edeef0"
bg="111c23"
bl="17242c"
#ac="f6b2b6"
fifo="/tmp/barfifo"

#trap 'pkill -P $$' SIGINT

tim() {
	if [[ $(cat /tmp/barblink) = ":" ]]; then
		echo " " > /tmp/barblink
		time="$(date "+%I %M")";
	else
		echo ":" > /tmp/barblink
		time="$(date "+%I:%M")";
	fi

	echo "t%{A:nottime:}$time%{A}" > $fifo
}

desktop() {
	echo "d$(bspc query -D -d focused --names)" > $fifo
}

volume() {
	muted="$(amixer -D pulse get Master | grep -i "\[off\]\|\[on\]" | awk '{print $6}' | sed -e '1!d' -e 's/\[//' -e 's/\]//')"

	local b="%{A4:vol -p up:}%{A5:vol -p down:}%{A3:vol -p m:}%{A:vol -p status vol:}"
	local a="%{A}%{A}%{A}%{A}"
	if [[ $muted = off ]]; then
		echo -e "v${b}${a}" > $fifo; return
	fi

	echo -e "v${b}${a}" > $fifo
}

bat() {
	cat /sys/class/power_supply/*/capacity &>/dev/null || return
	declare -i capacity status

	capacity="$(($(cat /sys/class/power_supply/*/capacity 3>/dev/null) / 4))"
	status=$(cat /sys/class/power_supply/*/status 2>/dev/null)

	case "$capacity" in
		0) bat=;;
		1) bat=;;
		2) bat=;;
		3) bat=;;
		*) bat=;;
	esac

	[[ $status = Charging ]] && bat=

	echo "b%{A4:light -A 10:}%{A5:light -U 10:}%{A:battery:}${bat}%{A}%{A}%{A}%{O8}" > $fifo
}


case $1 in
	-b) bat; exit;;
	-t) tim; exit;;
	-v) volume; exit;;
	-d) desktop; exit;;
esac

[[ -e $fifo ]] && rm $fifo
mkfifo $fifo

pkill bar
sleep 0.1

monitor="$(xrandr -q | grep primary | awk '{print $4}' | sed -e 's/x/ /g' -e 's/+/ /g')"
monitorName="$(xrandr -q | grep primary | awk '{print $1}')"
width="$(awk '{print $1}' <<< "$monitor" )"
offX="$(awk '{print $3}' <<< "$monitor")"
offY="$(awk '{print $4}' <<< "$monitor")"

(sleep 0.4;
bat;
volume;
desktop;
echo "t%{A:nottime:}$(date "+%I:%M")%{A}" > $fifo
) &

bspc config -m "$monitorName" top_padding 24
(sleep 1; xdo above -t $(xdo id -n root) $(xdo id -n lemonbar)) &

while read -r line < "$fifo"; do
	case $line in
		v*) vol="${line#?}";;
		b*) bat="${line#?}";;
		a*) asda="${line#?}";;
		t*) time="${line#?}";;
		d*) desk="${line#?}";;
	esac
	echo -e "%{B#ff$bl}%{O15}$time$asda%{O15}%{B-}%{r}%{B#ff$bl}%{O15}$desk%{O15}$bat$vol%{O15}%{B-}"
	sleep 0.01
done | lemonbar \
	-a 25 \
	-o -1 \
	-B "#ff$bg" \
	-F "#ff$fg" \
	-f "t kiwi Wide:size=10" \
	-f "t mango Wide:size=10" \
	-f "Hack Nerd Font:size=10" \
	-g "${width}x24+$offX+$offY" | bash &

while true; do
	bar -b;
	bar -t;
	sleep 1
done > $fifo &

lemonbar -g "100x1+$offX+$offY" -p

kill -- -0


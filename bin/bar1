#!/usr/bin/env bash

pkill bar

monitor="$(xrandr -q | grep primary | awk '{print $4}' | sed -e 's/x/ /g' -e 's/+/ /g')"
monitorName="$(xrandr -q | grep primary | awk '{print $1}')"
width="$(awk '{print $1}' <<< $monitor )"
offX="$(awk '{print $3}' <<< $monitor)"
offY="$(awk '{print $4}' <<< $monitor)"

fg="ccccee"
bg="1a1f2e"
ac="447bbe"

wifi="%{A:st -c floating -e nmtui-connect:}\uf1eb%{A}"

volume() {
	muted="$(amixer -D pulse get Master | grep -i "\[off\]\|\[on\]" | awk '{print $6}' | sed -e '1!d' -e 's/\[//' -e 's/\]//')"

	if [[ $muted = off ]]; then
		vol="%{B#ffbe405d}%{O300}%{B-}"; return
	fi

	amix="$(amixer -D pulse get Master | grep -i "\[off\]\|\[on\]" | sed -e '1!d' -e 's/\[//g' -e 's/\]//g')"
	volume="$(echo ${amix}  | awk '{gsub("%", ""); print $5}')"
	notvol="$(( 100 - $volume ))"
	vol="%{B#ff$ac}%{O$volume}%{B#ff$fg}%{O$notvol}%{B-}%{O20}"
}

workspaces() {
	local xda="$(bspc query -D --names | sort -n)"
	local active="$(bspc query -D -d focused --names)"
	for i in $(sed 's/\n/ /g' <<< $xda); do
		if [[ $i = $active ]]; then
			echo -en "%{B#ff$ac}%{O25}%{B-}%{O2}"
		else
			echo -en "%{B#ff$fg}%{O25}%{B-}%{O2}"
		fi
	done
}

testtime() {
	val=$1
	secs=4
	out=""

	while [[ $secs -gt 0 ]]; do
		if [[ $val -gt 30 ]]; then
			out+="%{B#ff$ac}%{O30}%{B-}%{O2}"
		elif [[ $val -le 0 ]]; then
			out+="%{B#ff$fg}%{O30}%{B-}%{O2}"
		else
			r=$((30 - $val))
			out+="%{B#ff$ac}%{O$val}%{B#ff$fg}%{O$r}%{B-}%{O2}"
		fi
		val=$(($val - 30))
		secs=$(($secs - 1))
	done
	echo "$out%{B-}"
}


thing() {

	if [[ $(bspc query -T -d | jq -r .layout) != monocle ]] || [[ $(bspc query -N -n .window -d focused | wc -l) = 1 ]]; then
		echo ""; return
	fi
	curname="$(bspc query -N -n)"
	for i in $(bspc query -N -n .window -d focused); do
		if [[ $curname = $i ]]; then
			echo -en "%{F#ff$ac}●  " 
		else
			echo -en "%{F#ff$fg}●  "
		fi
	done
	echo "%{F#ff$fg}"
}

# bspc config -m $monitorName top_padding 46

curdate() {
	notify-send \"$(date "+%a %d %b - %I:%M %p")\"
}

name() {
	name="$(xdotool getwindowfocus getwindowname | cut -c -40)"
	[[ $(wc -m <<<$name) = 41 ]] && name="$name..."
}

( sleep 1; xdo above -t $(xdo id -n root) $(xdo id -n lemonbar) ) &

bspc config -m HDMI-0 top_padding 3
bspc config top_monocle_padding 3
while true; do 
	name; volume

	DT=($(date "+%-I %-M"))
	tod="%{O20}$(testtime ${DT[0]}0)%{O18}$(testtime $((${DT[1]} * 2)))"

	time="%{A:nottime:}$(date "+%I:%M %p")%{A}"
	asda="$(thing)"
	desktop="$(bspc query -D -d focused --names)"

	echo -e "$tod %{c}$(workspaces) %{r}${vol}"

	sleep 0.2
done |
lemonbar -B "#00$bg" -F "#ff$fg" -f "Roboto Condensed:size=13" -f "Font Awesome:size=12" -g "${width}x3+$offX+$offY" -n "lemonbar" | bash

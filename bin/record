#!/bin/sh
# Modified from:
#   http://github.com/mitchweaver/bin
#
# Records the desktop or a selected rectangle with ffmpeg.
#

#
# Source:
#   https://gitlab.com/gaugek/dots/
#

#
# Syntax: 
# $ record <Offset X> <Offset Y> <Width> <Height> <Frames Per Second>
#
# Defaults suit my setup. You can see them below.
# 

if [ -n $1 ];then
  offsetX="$(echo -e "1440\n0" | dmenu -nf '#CCCCCC' -nb '#181A21' -sb '#6992c5' -sf '#181A21' -fn 'Iosevka term-16' -i -p "Offset for the X axis")"
  #offsetY="$(echo -e "0" | dmenu -i -p "Offset for the X axis")"
  width="$(echo -e "1920\n1366\n1440" | dmenu -nf '#CCCCCC' -nb '#181A21' -sb '#6992c5' -sf '#181A21' -fn 'Iosevka term-16' -i -p "Width")"
  height="$(echo -e "1080\n768\n900" | dmenu -nf '#CCCCCC' -nb '#181A21' -sb '#6992c5' -sf '#181A21' -fn 'Iosevka term-16' -i -p "Height")"
  rate="$(echo -e "30\n60" | dmenu -nf '#CCCCCC' -nb '#181A21' -sb '#6992c5' -sf '#181A21' -fn 'Iosevka term-16' -i -p "Framerate")"
fi

#[ -n "$1" ] && [-n" $offsetX"] && offsetX="$1" || offsetX=1440
#
#[ -n "$2" ] && [-n "$offsetY"] && offsetY="$2" || offsetY=0
#
#[ -n "$3" ] && [-n "$width"]  && width="$3"    || width=1920
#
#[ -n "$4" ] && [-n "$height"] && height="$4"   || height=1080
#
#[ -n "$5" ] && [-n "$rate"]   && rate="$5"     || rate=30


#if [ "$1" = "-s" ]
#then
#  set $(slop -q -o -f '%x %y %w %h') > /dev/null 2> /dev/null
#else
#  if i3-msg nop > /dev/null 2> /dev/null
#  then
#    OUTPUT="$(i3-msg -t get_workspaces | \
#    jq -r '.[] | select (.focused).output')"
#    JSON="$(i3-msg -t get_outputs | \
#    jq -r ".[]|select(.name==\"$OUTPUT\").rect")"
#    X="$(printf "$JSON" | jq -r '.x')"
#    Y="$(printf "$JSON" | jq -r '.y')"
#    W="$(printf "$JSON" | jq -r '.width')"
#    H="$(printf "$JSON" | jq -r '.height')"
#    set $(printf "%d %d %d %d" "$X" "$Y" "$W" "$H") > /dev/null 2> /dev/null
#  else
#    DESKTOP="$(xdotool get_desktop)"
#    [ "$DESKTOP" -eq 0 ] && DESKTOP="$(xrandr --nograb --query | \
#    grep -E '\sconnected\s' | \
#    wc -l)"
#    set $(xrandr --nograb --query | grep -E '\sconnected\s' | \
#    head -${DESKTOP} | \
#    tail -1 | \
#    grep -oE '[0-9]+x[0-9]+\+[0-9]+\+[0-9]+' | \
#    awk -F'(x|+)' '{print $3 " " $4 " " $1 " " $2}') > /dev/null 2> /dev/null
#  fi
#fi

#[ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ] && exit 1

if [[ $(echo -e "No\nYes" | dmenu -nf '#CCCCCC' -nb '#181A21' -sb '#6992c5' -sf '#181A21' -fn 'Iosevka term-16' -i -p "Are you ready to record?") = Yes ]]; then
  notify-send -t 2000 "recording started"

  ffmpeg -y -f x11grab -draw_mouse 1 -s ${width}x${height} \
      -r ${rate} -i :0.0+${offsetX},${offsetY} -qscale 0 \
      "$HOME/Videos/recordings/$(date '+%Y-%m-%d.%H:%M:%S')".mp4 \
      > /dev/null 2>&1
fi
#!/usr/bin/env bash

desktop() {
	echo "desktop=\"$(bspc query -D -d focused --names)\"" > /tmp/desktop
}

case $1 in
	-d) desktop; shift; exit;;
esac

pkill bar

monitor="$(xrandr -q | grep primary | awk '{print $4}' | sed -e 's/x/ /g' -e 's/+/ /g')"
monitorName="$(xrandr -q | grep primary | awk '{print $1}')"
width="$(( $(awk '{print $1}' <<< $monitor ) - 40 ))"
offX="$(( $(awk '{print $3}' <<< $monitor) + 20 ))"
offY="$(( $(awk '{print $4}' <<< $monitor) + 8 ))"

fg="ccccee"
bg="1a1f2e"
ac="447bbe"

wifi="%{A:st -c floating -e nmtui-connect:}\uf1eb%{A}"

thing() {

	if [[ $(bspc query -T -d | jq -r .layout) != monocle ]] || [[ $(bspc query -N -n .window -d focused | wc -l) = 1 ]]; then
		echo ""; return
	fi
	curname="$(bspc query -N -n)"
	for i in $(bspc query -N -n .window -d focused); do
		if [[ $curname = $i ]]; then
			echo -en "%{F#ff$ac}●  " 
		else
			echo -en "%{F#ff$fg}●  "
		fi
	done
	echo "%{F#ff$fg}"
}

curdate() {
	notify-send \"$(date "+%a %d %b - %I:%M %p")\"
}

name() {
	name="$(xdotool getwindowfocus getwindowname | cut -c -40)"
	[[ $(wc -m <<<$name) = 41 ]] && name="$name..."
}

bspc config -m $monitorName top_padding 44

(sleep 1; xdo above -t $(xdo id -n root) $(xdo id -n lemonbar)) &

while true; do
	echo "time=\"%{A:nottime:}$(date "+%I:%M %p")%{A}\"" > /tmp/time
	sleep 5;
done &

while true; do 
	. /tmp/desktop
	. /tmp/time
	name
	asda="$(thing)"
	echo -e "    $desktop     $asda %{c} $name %{r} $wifi     $time    "
done |
lemonbar -B "#ff$bg" -F "#ff$fg" -f "Roboto Condensed:size=13" -f "Font Awesome:size=12" -g "${width}x28+$offX+$offY" -n "lemonbar" | bash &

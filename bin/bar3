#!/usr/bin/env bash
#
#        GaugeK's bar
#   gitlab.com/GaugeK/dots
#

#set -x

fg="43566f"
fd="909cad"
bg="f7f9ff"
bl="eef0f5"
blr="e1e4ea"
ac="cd5e6f"
fifo="/tmp/barfifo"
#trap 'pkill -P $$' SIGINT

tim() {
	if [[ $(cat /tmp/barblink) = ":" ]]; then
		echo " " > /tmp/barblink
		time="$(date "+%A %I %M")";
	else
		echo ":" > /tmp/barblink
		time="$(date "+%A %I:%M")";
	fi

	echo "t%{A:nottime:}$time%{A}" > $fifo
}

nam() {
	echo "n$(xdotool getwindowfocus getwindowname)" > $fifo
}

desktop() {
	#echo "d$(bspc query -D -d focused --names)" > $fifo
	out=""
	f="$(bspc query -D -d focused --names)"
	for i in $(bspc query -D --names | sort -n | head -5); do
		if [[ $i = $f ]]; then
			out+="%{F#ff$fg}%{F-}"
		else
			out+="%{F#ff$fd}%{F-}"
		fi
	done
	echo -e "d$out" > $fifo
}

volume() {
	amix="$(amixer -D pulse get Master | grep -i "\[off\]\|\[on\]")"
	muted="$(awk '{print $6}' <<< $amix | sed -e '1!d' -e 's/\[//' -e 's/\]//')"
	vol="$(sed -e '1!d' -e 's/\[//g' -e 's/\]//g'  <<< $amix | grep -oi '[0-9][0-9]*%')"

	local b="%{A4:vol -p up:}%{A5:vol -p down:}%{A3:vol -p m:}%{A:vol -p status vol:}"
	local a="%{A}%{A}%{A}%{A}"
	if [[ $muted = off ]]; then
		echo -e "v${b} Muted${a}" > $fifo; return
	fi

	echo -e "v${b} $vol${a}" > $fifo
}

bat() {
	cat /sys/class/power_supply/*/capacity &>/dev/null || return
	declare -i capacity status

	cap="$(cat /sys/class/power_supply/*/capacity 2>/dev/null)"
	capacity="$(($cap / 4))"
	status=$(cat /sys/class/power_supply/*/status 2>/dev/null)

	case "$capacity" in
		0) bat=;;
		1) bat=;;
		2) bat=;;
		3) bat=;;
		*) bat=;;
	esac

	[[ $status = Charging ]] && bat=

	echo "b%{A4:light -A 10:}%{A5:light -U 10:}%{A:battery:}${bat} $cap%%{A}%{A}%{A}%{O15}" > $fifo
}


case $1 in
	-b) bat; exit;;
	-t) tim; exit;;
	-n) nam; exit;;
	-v) volume; exit;;
	-d) desktop; exit;;
esac

[[ -e $fifo ]] && rm $fifo
mkfifo $fifo

killall lemonbar
sleep 0.1

monitor="$(xrandr -q | grep primary | awk '{print $4}' | sed -e 's/x/ /g' -e 's/+/ /g')"
monitorName="$(xrandr -q | grep primary | awk '{print $1}')"
width="$(($(awk '{print $1}' <<< "$monitor" ) - 16))"
offX="$(($(awk '{print $3}' <<< "$monitor") + 8))"
offY="$(($(awk '{print $4}' <<< "$monitor") + 8))"

(sleep 0.4;
bat;
volume;
desktop;
) &

bspc config -m "$monitorName" top_padding 40
(sleep 1; xdo above -t $(xdo id -n root) $(xdo id -n lemonbar)) &

while read -r line < "$fifo"; do
	case $line in
		v*) vol="${line#?}";;
		b*) bat="${line#?}";;
		a*) asda="${line#?}";;
		t*) time="${line#?}";;
		n*) name="${line#?}";;
		d*) desk="${line#?}";;
	esac
	echo -e "%{O15}$desk%{O15}%{B-}%{c}$time%{r}%{O15}%{O15}$bat$vol%{O15}"
	sleep 0.01
done | (lemonbar \
	-a 25 \
	-B "#ff$bg" \
	-F "#ff$fg" \
	-f "kiwi:size=10" \
	-f "t mango Wide:size=10" \
	-g "${width}x24+$offX+$offY"; kill -- -0)| bash &

#while true; do
#	bar -n;
#	sleep 0.1
#done

while true; do
	bar -b;
	bar -t;
	sleep 1
done > $fifo &

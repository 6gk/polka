#!/bin/sh
#
##
##  The most inefficient/bloated screenshot script you will ever see!
##
#
# deps:
#  - crud     selecting area
#  - maim     taking selection scrots
#  - ffmpeg   taking fullscreen screenshots
#  - feh      freezing screen
#  - kill     closing the fake freeze
#  - wmutils  getting combined screen size
#  - mmutils  getting dimensions of focused monitor
#  - xclip    copying image
#
# the reason for ffmpeg + maim is because ffmpeg is
#  faster at taking fullscreen screenshots, and
#  maim is faster at smaller screenshots.
#

n="$HOME/opt/x/pics/$(date +%F_%H-%M-%S).png"
mkdir -p "${n%/*}"

ff() {
	ffmpeg -y -loglevel error -f x11grab -draw_mouse "$3" \
		-video_size "${1%%+*}" -i ":0.0+${1#*+}" -vframes 1 "$2"
}

case $1 in
	# freeze & screenshot selection
	# don't worry, you're not meant to be able to read this :^)
	-s)
		mw="$(wattr wh "$(lsw -r)" | tr \  x)"
		ff "$mw+0,0" /tmp/scr.png 1
		feh -g "${mw%?}2+0+-1" --class feh-nb /tmp/scr.png &
		pid=$!

		w="$(sel)" &&
		n="${n%%.*}-${w%%+*}.png" &&
		maim -u -g "$w" "$n"
		# ff "$w" "$n" 0
		kill $pid
	;;
	# screenshot current monitor
	*)
		ff "$(mattr -g "$(pfm)")" "$n" 0
	;;
esac

# copy image
xclip -sel clipboard -t image/png "$n"
